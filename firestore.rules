rules_version='2';

service cloud.firestore {
  match /databases/{database}/documents {
      
      // Helper function to check if only allowed fields are being updated
      function isUpdatingOnly(allowedFields) {
        return request.resource.data.diff(resource.data).affectedKeys().hasOnly(allowedFields);
      }

      // Users: 
      // - Read: Auth'd users.
      // - Create: restricted (prevent setting 'isPro' or high 'invitesRemaining').
      // - Update: restricted whitelist (map settings, auth sync). Sensitive updates (Vibe Profile) via Server Actions.
      match /users/{userId} {
        allow read: if request.auth != null;
        
        allow create: if request.auth != null && request.auth.uid == userId 
          && (!('isPro' in request.resource.data))
          && (!('vibeLikesReceived' in request.resource.data))
          && (!('invitesRemaining' in request.resource.data) || request.resource.data.invitesRemaining == 1);

        allow update: if request.auth != null && request.auth.uid == userId
          // && isUpdatingOnly(['mapSettings', 'location', 'lastLocationUpdate', 'theme', 'displayName', 'photoURL', 'email', 'phoneNumber', 'invitedBy', 'vector', 'incognito', 'vibeProfile', 'vibeActive', 'vibeLikesReceived', 'lastSeen', 'invitesRemaining', 'didInvite']);
      }

      // Location history: users can write their own entries
      match /locationHistory/{userId}/entries/{entryId} {
        allow read, write: if request.auth != null && request.auth.uid == userId;
      }

      // Invites: 
      // - Read: Public (needed for invite validation on login).
      // - Write: Server Actions ONLY (create/cancel/accept).
      match /invites/{inviteId} {
        allow read: if true;
        allow write: if false; 
      }

      // Vibe Likes: auth'd users can read; writes via Server Actions
      match /vibe-likes/{likeId} {
        allow read: if request.auth != null;
        allow write: if false; 
      }

      // Vibe Interactions: owner can read AND write (record seen/swipes)
      match /vibe-interactions/{userId} {
        allow read, write: if request.auth != null && request.auth.uid == userId;
      }

      // Vibe Messages Conversation Metadata
      match /vibe-messages/{conversationId} {
        allow read: if request.auth != null;
        // Allow creating/updating if user is a participant
        allow write: if request.auth != null && (
          (request.resource.data.participants.hasAny([request.auth.uid])) || 
          (resource != null && resource.data.participants.hasAny([request.auth.uid]))
        );
      }

      // Vibe Messages Subcollection
      match /vibe-messages/{conversationId}/messages/{messageId} {
        allow read: if request.auth != null;
        // Allow create if 'from' is the auth user
        allow create: if request.auth != null && request.resource.data.from == request.auth.uid;
      }

      // Default deny
      match /{document=**} {
        allow read, write: if false;
      }
  }
}
